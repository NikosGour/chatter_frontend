<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
		crossorigin="anonymous"></script>
	<!-- <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script> -->
</head>

<body>
	<div class="container mx-auto">
		<h1>Chatter</h1>
		<div class="border-2">
			<label for="user_input" class="me-3">Text message</label>
			<textarea id="user_input" class="w-50"></textarea>
			<button id="send_button" class="btn btn-primary ms-3">Send</button>
		</div>
		<div id="messages" class="border-black border-5">

		</div>
	</div>
</body>
<script>
	let ws;
	document.addEventListener('DOMContentLoaded', () => {
		const messagesDiv = document.getElementById('messages');
		fetch('http://localhost:8080/message')
			.then(response => response.json())
			.then(data => {
				data.forEach(message => {
					const messageElement = document.createElement('div');
					const date_sent = new Date(message.date_sent).toLocaleString();
					messageElement.textContent = `${date_sent} - ${message.sender.username}: ${message.text}`;
					messagesDiv.appendChild(messageElement);
				});
			})
			.catch(error => {
				console.error('Error:', error);
			});

		ws = new WebSocket("ws://localhost:8080/ws/messages?uid=85b0fcd7-6c15-4a49-bac5-d59a74a675c4");
		ws.onmessage = function (event) {
			console.log("WebSocket message received:", event.data);

			const message = JSON.parse(event.data);
			const messageElement = document.createElement('div');
			const date_sent = new Date(message.date_sent).toLocaleString();
			messageElement.textContent = `${date_sent} - ${message.sender.username}: ${message.text}`;
			messagesDiv.appendChild(messageElement);
		};

		ws.onopen = function () {
			console.log("WebSocket connection opened");
		};

		ws.onclose = function (event) {
			console.log("WebSocket connection closed:", event);
		}
	});

	const sendButton = document.getElementById('send_button');
	sendButton.addEventListener('click', () => {
		const userInput = document.getElementById('user_input');
		const message = {
			sender: { id: "85b0fcd7-6c15-4a49-bac5-d59a74a675c4" },
			tab: { id: "15378972-c26f-43b2-a20c-0c4d43d9f7dc" },
			text: userInput.value,
			date_sent: new Date()
		}
		console.log("message: ", message);
		ws.send(JSON.stringify(message));
		// fetch('http://localhost:8080/message', {
		// 	method: 'POST',
		// 	headers: {
		// 		'Content-Type': 'application/json'
		// 	},
		// 	body: JSON.stringify(message)
		// })
		// 	.then(response => response.json())
		// 	.then(data => {
		// 		console.log("data: ", data);
		// 	})
		// 	.catch(error => {
		// 		console.error('Error:', error);
		// 	});

	});
</script>

</html>